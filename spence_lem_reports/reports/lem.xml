<?xml version="1.0" encoding="utf-8"?>
<odoo>

<template id="portal_my_lem_spence" name="Spence: LEM Portal" inherit_id="industry_fsm_report.portal_my_worksheet" primary="True">
    <xpath expr="//t[@t-set='backend_url']" position="attributes">
        <attribute name="t-value">'/web#model=project.task&amp;id=%s&amp;action=%s&amp;view_type=form' % (lem.task_id.id, source_action_id)</attribute>
    </xpath>
    <xpath expr="//div[hasclass('o_portal_sidebar')]" position="attributes">
        <attribute name="id">o_spence_lem_worksheet_portal</attribute>
    </xpath>
    <xpath expr="//t[@t-set='source_action_id']" position="attributes">
        <attribute name="t-value">lem.env.ref('spence_lem_reports.spence_project_task_action').id</attribute>
    </xpath>

    <xpath expr="//div[hasclass('o_download_pdf')]" position="replace">
        <div class="o_download_pdf btn-toolbar flex-sm-nowrap">
            <div class="btn-group flex-grow-1 mr-1 mb-1">
                <a class="btn btn-secondary btn-block o_download_btn" t-att-href="task.get_portal_url(suffix='/lem', report_type='pdf', download=True)" title="Download">
                    <i class="fa fa-download"/>
                    Download
                </a>
            </div>
            <div class="btn-group flex-grow-1 mb-1">
                <a class="btn btn-secondary btn-block o_print_btn o_portal_invoice_print" t-att-href="task.get_portal_url(suffix='/lem', report_type='pdf')" title="Print" target="_blank">
                    <i class="fa fa-print"/>
                    Print
                </a>
            </div>
        </div>
    </xpath>

    <xpath expr="//h4[@class='modal-title']" position="replace">
        <h4 class="modal-title">Sign LEM Sheet</h4>
    </xpath>
    <xpath expr="//t[@t-set='call_url']" position="attributes">
        <attribute name="t-value">task.get_portal_url(suffix='/sign/%s' % source)</attribute>
    </xpath>
    <xpath expr="//div[@role='status']" position="replace">
        <div t-if="message == 'sign_ok'" class="alert alert-success alert-dismissable d-print-none text-center mt-2" role="status">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">Ã—</button>
            <strong>Thank You!</strong><br/>
            Your LEM Sheet is now signed.
        </div>
    </xpath>
    <xpath expr="//div[@id='worksheet_content']" position="replace">
        <div t-attf-class="card p-3" name="Content" id="worksheet_content">
            <t t-set="doc" t-value="lem"/>
            <div t-call="spence_lem_reports.spence_lem_sheet_page"/>
        </div>    
    </xpath>
</template>
    
    <template id="spence_lem_sheet" name="Spence: LEM Sheets">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.external_layout">
                    <t t-set="hide_footer" t-value="True"/>
                    <t t-call="spence_lem_reports.spence_lem_sheet_page" t-lang="doc.partner_id.lang"/>
                </t>
            </t>
        </t>
    </template>

    <template id="spence_lem_sheet_page" name="Spence: LEM Sheet, Page">
        <div class="page">
            <div class="container-fluid">
                <div class="row p-2"><div class="col-12 text-center">
                    <h1>Daily L.E.M. Sheet</h1>
                </div></div>
                <div class="row p-2"><div class="col-12">
                    <t t-call="spence_lem_reports.spence_info_block"/>
                </div></div>
                <div class="row p-2"><div class="col-12">
                    <t t-call="spence_lem_reports.spence_task_block"/>
                </div></div>
                <div class="row p-2"><div class="col-12">
                    <t t-call="spence_lem_reports.spence_timesheet_table"/>
                </div></div>
                <div class="row p-2">
                    <t t-set="equipment_order_lines" t-value="doc.sale_order_id.order_line.filtered(lambda l: l.product_id.product_type_lem == 'equipment')"/>
                    <div class="col-6">
                        <t t-call="spence_lem_reports.spence_equipment_material_table">
                            <t t-set="table_label" t-value="'Equipment'"/>
                            <t t-set="order_lines" t-value="equipment_order_lines"/>
                        </t>
                    </div>
                    <t t-set="material_order_lines" t-value="doc.sale_order_id.order_line.filtered(lambda l: l.product_id.product_type_lem == 'material')"/>
                    <div class="col-6">
                        <t t-call="spence_lem_reports.spence_equipment_material_table">
                            <t t-set="table_label" t-value="'Materials'"/>
                            <t t-set="order_lines" t-value="material_order_lines"/>
                        </t>    
                    </div>
                </div>
                <div class="row p-2"><div class="col-12">
                    <t t-call="spence_lem_reports.spence_lem_summary_block"/>
                </div></div>
                <div class="row p-2">
                    <div class="col-6">
                        <t t-call="spence_lem_reports.spence_signature_block">
                            <t t-set="signature" t-value="doc.employee_signature"/>
                            <t t-set="signature_name" t-value="doc.employee_id.name"/>
                            <t t-set="signature_date" t-value="doc.employee_signature_date"/>
                        </t>
                    </div>
                    <div class="col-6">
                        <t t-call="spence_lem_reports.spence_signature_block">
                            <t t-set="signature" t-value="doc.customer_signature"/>
                            <t t-set="signature_name" t-value="doc.customer_signature_name"/>
                            <t t-set="signature_date" t-value="doc.customer_signature_date"/>
                        </t>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="spence_equipment_material_table">
        <t t-if="order_lines">
            <h3><t t-esc="table_label"/></h3>
            <div class="table-responsive-sm" >
                <table class="table table-sm o_main_table" style="height:100%">
                    <thead><tr>
                        <th class="text-left">Description</th>
                        <th class="text-center" style="width: 25%">Quantity</th>
                    </tr></thead>
                    <tbody class="sale_tbody">
                        <t t-foreach="order_lines" t-as="line"><tr>
                            <td class="text-left"><span t-field="line.name"/></td>
                            <td class="text-center"><span t-field="line.product_uom_qty"/></td>
                        </tr></t>
                    </tbody>
                </table>
            </div>
        </t>
    </template>
    
    <template id="spence_timesheet_table">
        <t t-if="doc.task_id.allow_timesheets and doc.task_id.timesheet_ids">
            <h3>Timesheets</h3>
            <div class="table-responsive-sm">
                <table class="table table-sm o_main_table">
                    <thead><tr>
                        <th class="text-left" style="width: 15%">Date</th>
                        <th class="text-left" style="width: 25%">Employee</th>
                        <th class="text-left">Description</th>
                        <th class="text-left" style="width: 15%">Time Spent</th>
                    </tr></thead>
                    <tbody class="sale_tbody">
                        <t t-foreach="doc.task_id.timesheet_ids" t-as="line"><tr>
                            <td class="text-left"><span t-field="line.date"/></td>
                            <td class="text-left"><span t-field="line.employee_id.name"/></td>
                            <td class="text-left"><span t-field="line.display_name"/></td>
                            <td class="text-left">
                                <span t-field="line.unit_amount" t-options="{'widget': 'float_time'}"/><span> hour(s)</span>
                            </td>
                        </tr></t>
                    </tbody>
                </table>
            </div>
        </t>
    </template>

    <template id="spence_info_block">
        <div class="row">
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'Client'"/><t t-set="value"><span t-field="doc.partner_id.name"/></t></t></div>
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'Asset'"/><t t-set="value"><span t-field="doc.sale_order_id.asset_id"/></t></t></div>
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'ID'"/><t t-set="value"><span t-field="doc.id"/></t></t></div>
        </div>
        <div class="row">
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'Location'"/><t t-set="value"><span t-field="doc.sale_order_id.location"/></t></t></div>
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'PO Number'"/><t t-set="value"><span t-field="doc.sale_order_id.po_number"/></t></t></div>
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'Date'"/><t t-set="value"><span t-field="doc.date_performed"/></t></t></div>
         </div>
    </template>

    <template id="spence_lem_summary_block">
        <h3>Daily Summary</h3>
        <div class="row mb-2">
            <div class="col-12">
                <t t-esc="doc.note"/>
                <span t-if="not doc.note">No daily summary provided</span>
            </div>
        </div>
        <div class="row">
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'Shift'"/><t t-set="value"><span t-field="doc.shift_type"/></t></t></div>
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'LOA'"/><t t-set="value"><span t-field="doc.loa"/></t></t></div>
            <div class="col-4"><t t-call="spence_lem_reports.spence_field_block"><t t-set="field_label" t-value="'Accommodations'"/><t t-set="value"><span t-field="doc.accommodations"/></t></t></div>
        </div>
    </template>

    <template id="spence_task_block">
        <div class="row align-items-center">
            <div class="col-8 text-left"><strong>Task: <span t-field="doc.name"/></strong></div>
            <div class="col-4 text-right"><strong t-field="doc.sale_order_id.name"/></div>
        </div>
    </template>

    <template id="spence_signature_block">
        <t t-if="signature">
            <div class="row"><div class="col-12 text-center" >
                <img t-att-src="image_data_uri(signature)" style="max-height: 2cm; max-width: 8cm;"/>
            </div></div>
            <div class="row">
                <div class="col-8 text-left"><strong><t t-esc="signature_name"/></strong></div>
                <div class="col-4 text-right"><t t-esc="signature_date"/></div>
            </div>
        </t>
    </template>

    <template id="spence_field_block">
        <div class="row">
            <div class="col text-left"><strong><t t-esc="field_label"/>: </strong></div>
            <div class="col text-right"><t t-raw="value"/></div>
        </div>
    </template>
</odoo>